<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="WorkoutTracker.Views.TodayPage"
    x:Name="TodayPageRoot"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="Today">

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="12">

            <!-- Session header -->
            <Label  Text="{Binding SessionHeader}"
                    IsVisible="{Binding HasActiveSession}"
                    FontAttributes="Bold"
                    Margin="0,0,0,4" />

            <!-- Start / End session -->
            <Button Text="Start Session"
                    Command="{Binding StartSessionCommand}"
                    IsVisible="{Binding HasActiveSession, Converter={StaticResource InverseBoolConverter}}" />

            <Button Text="End Session"
                    Command="{Binding EndSessionCommand}"
                    IsVisible="{Binding HasActiveSession}" />

            <!-- Category label -->
            <Label Text="Category:" 
                   FontAttributes="Bold" 
                   Margin="0,8,0,0" />
            
            <!-- Category actions -->
            <HorizontalStackLayout Spacing="8">
                <Button Text="Add"
                        Command="{Binding AddCategoryCommand}" />
                <Button Text="Rename"
                        Command="{Binding RenameCategoryCommand}"
                        IsEnabled="{Binding SelectedCategory, Converter={StaticResource NullToBoolConverter}}" />
                <Button Text="Delete"
                        Command="{Binding DeleteCategoryCommand}"
                        IsEnabled="{Binding SelectedCategory, Converter={StaticResource NullToBoolConverter}}" />
            </HorizontalStackLayout>
           
            <!-- Category + Exercise pickers side by side -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                <Picker Grid.Column="0"
                    Title="Category"
                    ItemsSource="{Binding CategoryOptions}"
                    ItemDisplayBinding="{Binding Name}"
                    SelectedItem="{Binding SelectedCategory}" />

                <Picker Grid.Column="1"
                    Title="Exercise"
                    ItemsSource="{Binding ExerciseOptions}"
                    ItemDisplayBinding="{Binding Name}"
                    SelectedItem="{Binding SelectedExercise}" />
                </Grid>
            
            <!-- Goal -->
                <Label Text="Goal:" 
                   FontAttributes="Bold" 
                   Margin="0,8,0,0" />

                <Picker x:Name="GoalPicker"
                    Title="Select goal"
                    SelectedIndexChanged="OnGoalChanged">
                <Picker.Items>
                    <x:String>Strength</x:String>
                    <x:String>Hypertrophy</x:String>
                    <x:String>Endurance</x:String>
                    <x:String>No Recommendation</x:String>
                </Picker.Items>
                </Picker>

            <!-- If no exercises in this category, show a prompt -->
                <HorizontalStackLayout Spacing="8"
                            IsVisible="{Binding HasExercisesInCategory, Converter={StaticResource InverseBoolConverter}}">
                    <Label Text="No exercises in this category yet." Opacity="0.7" />
                    <Button Text="Add exercise"
                Command="{Binding AddExerciseCommand}" />
                </HorizontalStackLayout>

            <!-- Compact exercise actions (only when there are exercises) -->
                <HorizontalStackLayout Spacing="8"
                            IsVisible ="{Binding HasExercisesInCategory}">
                <Button Text="Add exercise"
                            Command="{Binding AddExerciseCommand}"
                            LineBreakMode="TailTruncation" />
                <Button Text="Rename"
                            Command="{Binding RenameExerciseCommand}"
                            IsEnabled="{Binding SelectedExercise, Converter={StaticResource NullToBoolConverter}}" />
                <Button Text="Move"
                            Command="{Binding MoveExerciseCommand}"
                            IsEnabled="{Binding SelectedExercise, Converter={StaticResource NullToBoolConverter}}" />
                </HorizontalStackLayout>

            <!-- Inputs: reps + weight -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                <Entry Grid.Column="0"
                       Keyboard="Numeric"
                       Placeholder="Reps"
                       Text="{Binding Reps}" />

                <Entry Grid.Column="1"
                       Keyboard="Numeric"
                       Placeholder="Weight (kg)"
                       Text="{Binding WeightText}" />
            </Grid>

            <!-- RPE -->
            <Picker
                    Title="RPE (optional)"
                    ItemsSource="{Binding RpeOptions}"
                    ItemDisplayBinding="{Binding Display}"
                    SelectedItem="{Binding SelectedRpe}"
                    HorizontalOptions="Fill" />

            <Button Text="Add Set"
                    Command="{Binding AddSetCommand}"
                    IsEnabled="{Binding HasActiveSession}"
                    HorizontalOptions="Fill"
                    Margin="0,8,0,0" />

            <!-- Today's sets with swipe-to-delete -->
            <CollectionView ItemsSource="{Binding TodaysSets}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems Mode="Reveal">
                                    <SwipeItem
                                        Text="Delete"
                                        IconImageSource="delete.png"
                                        BackgroundColor="IndianRed"
                                        Command="{Binding BindingContext.DeleteSetCommand, Source={x:Reference Name=TodayPageRoot}}"
                                        CommandParameter="{Binding}" />
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <Grid Padding="8" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                <Label Text="{Binding TimestampUtc, StringFormat='{}{0:HH:mm}'}" />

                                <VerticalStackLayout Grid.Column="1">
                                    <Label Text="{Binding ExerciseName}" />
                                    <!-- Reps + (optional) RPE inline -->
                                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                                        <Label Text="{Binding Reps, StringFormat='Reps: {0}'}"
                                        FontSize="12" Opacity="0.7" />
                                        <Label Grid.Column="1" Text="Â·" FontSize="12" Opacity="0.5"
                                        IsVisible="{Binding Rpe, Converter={StaticResource NullToBoolConverter}}" />
                                        <Label Grid.Column="2"
                                        Text="{Binding Rpe, StringFormat='RPE: {0:0.#}'}"
                                        FontSize="12" Opacity="0.7"
                                        IsVisible="{Binding Rpe, Converter={StaticResource NullToBoolConverter}}" />
                                    </Grid>
                                </VerticalStackLayout>

                                <Label Grid.Column="2"
                                Text="{Binding Weight, StringFormat='{0:0.##} kg'}" />
                            </Grid>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
