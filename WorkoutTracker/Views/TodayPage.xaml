<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="WorkoutTracker.Views.TodayPage"
    x:Name="TodayPageRoot"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="Today">

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="12">

            <!-- Session header -->
            <Grid ColumnDefinitions="Auto,*">
                <Label Text="Session:" FontAttributes="Bold" />
                <Label Grid.Column="1"
                       Text="{Binding CurrentSession.Id, StringFormat='ID {0}'}"
                       IsVisible="{Binding CurrentSession, Converter={StaticResource NullToBoolConverter}}" />
            </Grid>

            <!-- Start / End session -->
            <Button Text="Start Session"
                    Command="{Binding StartSessionCommand}"
                    IsVisible="{Binding HasActiveSession, Converter={StaticResource InverseBoolConverter}}" />

            <Button Text="End Session"
                    Command="{Binding EndSessionCommand}"
                    IsVisible="{Binding HasActiveSession}" />

            <!-- Category picker -->
            <Picker Title="Category"
                    ItemsSource="{Binding CategoryOptions}"
                    ItemDisplayBinding="{Binding Name}"
                    SelectedItem="{Binding SelectedCategory}" />
            
            <!-- Category actions -->
            <HorizontalStackLayout Spacing="8">
                <Button Text="Add"
                        Command="{Binding AddCategoryCommand}" />
                <Button Text="Rename"
                        Command="{Binding RenameCategoryCommand}"
                        IsEnabled="{Binding SelectedCategory}" />
                <Button Text="Delete"
                        Command="{Binding DeleteCategoryCommand}"
                        IsEnabled="{Binding SelectedCategory}" />
            </HorizontalStackLayout>
           
                <!-- Category + Exercise pickers -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                <Picker Grid.Column="0"
                    Title="Category"
                    ItemsSource="{Binding CategoryOptions}"
                    ItemDisplayBinding="{Binding Name}"
                    SelectedItem="{Binding SelectedCategory}" />

                <Picker Grid.Column="1"
                    Title="Exercise"
                    ItemsSource="{Binding ExerciseOptions}"
                    ItemDisplayBinding="{Binding Name}"
                    SelectedItem="{Binding SelectedExercise}" />
                </Grid>

                <!-- Compact actions so they don’t run off-screen -->
                <HorizontalStackLayout Spacing="8">
                    <Button Text="Add exercise"
                    Command="{Binding AddExerciseCommand}"
                    LineBreakMode="TailTruncation"
                    HorizontalOptions="Start" />

                    <Button Text="Rename"
                    Command="{Binding RenameExerciseCommand}"
                    IsEnabled="{Binding SelectedExercise, Converter={StaticResource NullToBoolConverter}}" />

                    <Button Text="Move"
                    Command="{Binding MoveExerciseCommand}"
                    IsEnabled="{Binding SelectedExercise, Converter={StaticResource NullToBoolConverter}}" />
                </HorizontalStackLayout>


                <!-- Exercise quick actions -->
                <HorizontalStackLayout Spacing="8">
                    <Button Text="Rename exercise"
                    Command="{Binding RenameExerciseCommand}"
                    IsEnabled="{Binding SelectedExercise, Converter={StaticResource NullToBoolConverter}}" />
                    <Button Text="Move to category"
                    Command="{Binding MoveExerciseCommand}"
                    IsEnabled="{Binding SelectedExercise, Converter={StaticResource NullToBoolConverter}}" />
                </HorizontalStackLayout>


            <!-- Inputs: reps + weight -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                <Entry Grid.Column="0"
                       Keyboard="Numeric"
                       Placeholder="Reps"
                       Text="{Binding Reps}" />

                <Entry Grid.Column="1"
                       Keyboard="Numeric"
                       Placeholder="Weight (kg)"
                       Text="{Binding WeightText}" />
            </Grid>

            <!-- RPE -->
            <Picker
                    Title="RPE (optional)"
                    ItemsSource="{Binding RpeOptions}"
                    ItemDisplayBinding="{Binding Display}"
                    SelectedItem="{Binding SelectedRpe}"
                    HorizontalOptions="Fill" />

            <Button Text="Add Set"
                    Command="{Binding AddSetCommand}"
                    IsEnabled="{Binding HasActiveSession}"
                    HorizontalOptions="Fill"
                    Margin="0,8,0,0" />

            <!-- Today's sets with swipe-to-delete -->
            <CollectionView ItemsSource="{Binding TodaysSets}">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems Mode="Reveal">
                                    <SwipeItem
                                        Text="Delete"
                                        IconImageSource="delete.png"
                                        BackgroundColor="IndianRed"
                                        Command="{Binding BindingContext.DeleteSetCommand, Source={x:Reference Name=TodayPageRoot}}"
                                        CommandParameter="{Binding}" />
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <Grid Padding="8" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                <Label Text="{Binding TimestampUtc, StringFormat='{}{0:HH:mm}'}" />

                                <VerticalStackLayout Grid.Column="1">
                                    <Label Text="{Binding ExerciseName}" />
                                    <!-- Reps + (optional) RPE inline -->
                                    <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                                        <Label Text="{Binding Reps, StringFormat='Reps: {0}'}"
                                        FontSize="12" Opacity="0.7" />
                                        <Label Grid.Column="1" Text="·" FontSize="12" Opacity="0.5"
                                        IsVisible="{Binding Rpe, Converter={StaticResource NullToBoolConverter}}" />
                                        <Label Grid.Column="2"
                                        Text="{Binding Rpe, StringFormat='RPE: {0:0.#}'}"
                                        FontSize="12" Opacity="0.7"
                                        IsVisible="{Binding Rpe, Converter={StaticResource NullToBoolConverter}}" />
                                    </Grid>
                                </VerticalStackLayout>

                                <Label Grid.Column="2"
                                Text="{Binding Weight, StringFormat='{0:0.##} kg'}" />
                            </Grid>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
